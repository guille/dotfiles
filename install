#!/usr/bin/env bash
# shellcheck disable=SC1091

set -e

# flags
SELECT=0
FORCE_PROFILE=0
while (($#)); do
  case "$1" in
    -s|--select) SELECT=1 ;;
    -f|--force-profile) FORCE_PROFILE=1 ;;
    --) shift; break ;;
    *) echo "unknown option: $1" >&2; exit 2 ;;
  esac
  shift
done

# Exported so the module install scripts have a ref to the base
SCRIPT_BASE_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
export SCRIPT_BASE_DIR

source "$SCRIPT_BASE_DIR/common" || exit 1

populate_os_zvars() {
	os="$(uname -s)"

	case "$os" in
	Linux*)
		echo "export DOTFILES_OS=Linux" > "$SCRIPT_BASE_DIR/zsh/zvars"
		if command_exists pacman; then
			echo "export DOTFILES_DISTRO=Arch" >> "$SCRIPT_BASE_DIR/zsh/zvars"
		elif command_exists dnf; then
			echo "export DOTFILES_DISTRO=Fedora" >> "$SCRIPT_BASE_DIR/zsh/zvars"
		fi
		;;
	Darwin*)
		echo "export DOTFILES_OS=OSX" > "$SCRIPT_BASE_DIR/zsh/zvars"
		;;
	*)
		errorprint "Unsupported OS: $os"
		exit 1
		;;
	esac
}

populate_profile_zvars() {
	choices=("personal" "work" "hybrid")

	if command_exists fzf; then
		profile=$(printf "%s\n" "${choices[@]}" | fzf --prompt="Select profile: ")
	else
		echo "Select profile:"
		select opt in "${choices[@]}"; do
			if [[ -n "$opt" ]]; then
				profile="$opt"
				break
			fi
		done
	fi

	# If user aborted, bail
	if [[ -z "${profile:-}" ]]; then
		errorprint "No profile selected."
		exit 1
	fi

	echo "export DOTFILES_PROFILE=$profile" >> "$SCRIPT_BASE_DIR/zsh/zvars"
}

populate_os_zvars
if [[ -z "${DOTFILES_PROFILE:-}" || "$FORCE_PROFILE" -eq 1 ]]; then
	populate_profile_zvars
else # the file gets re-created
	echo "export DOTFILES_PROFILE=$DOTFILES_PROFILE" >> "$SCRIPT_BASE_DIR/zsh/zvars"
fi

source "$SCRIPT_BASE_DIR/zsh/zvars"
infoprint "[main] configured & loaded zvars"


modules_to_install=(
	system # always first!
	zsh
	mise
	ruby
	go
	python
	node
	git
	sublime
	mpd
	ghostty
	hyprland
	waybar
	mpv
	nnn
	thunar
	ripgrep
	nvim
	rofi
	dunst
	opencode
	tailscale
	mybin
	bat
	restic
	fd
	dnie
	flashspace
)

# interactively pick modules
if (( SELECT )); then
	if ! command_exists fzf; then
		errorprint "error: --select/-s requires fzf"
		exit 1
	fi
	choices=$(printf "%s\n" "${modules_to_install[@]}" | sort -r | fzf -m --bind enter:accept-non-empty --prompt="Select modules to install > ")
	modules_to_install=( $(echo "$choices") )
fi

for module in "${modules_to_install[@]}"; do
	infoprint "[$module] installing..."
	bash "$SCRIPT_BASE_DIR/$module/__install"
	infoprint "[main] $module done"
done

infoprint "[main] done"

#!/usr/bin/env bash
set -e

if ! git rev-parse --is-inside-work-tree &> /dev/null; then
    echo "Error: Not inside a git repository"
    exit 1
fi

# Get the remote URL
remote_url=$(git config --get remote.origin.url)

if [ -z "$remote_url" ]; then
    echo "Error: No remote origin found"
    exit 1
fi


# Convert SSH URL to HTTPS
# git@github.com:user/repo.git -> https://github.com/user/repo
# https://github.com/user/repo.git -> https://github.com/user/repo
url=$(echo "$remote_url" | sed -e 's/git@/https:\/\//' -e 's/\.com:/\.com\//' -e 's/\.git$//')

# Get current branch
branch=$(git rev-parse --abbrev-ref HEAD)

# If a file argument is provided
if [ -n "$1" ]; then
    # Get the repo root
    repo_root=$(git rev-parse --show-toplevel)
    # Get relative path from repo root
    if [ -f "$1" ]; then
        rel_path=$(realpath --relative-to="$repo_root" "$1")
    else
        rel_path="$1"
    fi

    # Construct file URL (works for GitHub and GitLab)
    url="${url}/blob/${branch}/${rel_path}"
fi

# Open in browser
if command -v xdg-open &> /dev/null; then
    xdg-open "$url"
elif command -v open &> /dev/null; then
    open "$url"
else
    echo "$url"
fi
